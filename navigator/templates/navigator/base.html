<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 添加防止缓存的meta标签 -->
    <meta
      http-equiv="Cache-Control"
      content="no-cache, no-store, must-revalidate"
    />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>医院内部导航站</title>
    <!-- 引入TailwindCSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <!-- 引入FontAwesome图标 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- HTMX JS库 -->
    <script src="https://unpkg.com/htmx.org@1.9.2?v={% now 'U' %}"></script>
    {% load static %}
    <!-- 为本地静态资源添加时间戳版本号 -->
    <link
      rel="stylesheet"
      href="{% static 'css/navigator.css' %}?v={% now 'U' %}"
    />
    <style>
      /* 搜索结果样式 */
      .search-results {
        max-height: 400px;
        overflow-y: auto;
        background-color: white !important;
      }

      .search-result-item {
        border-bottom: 1px solid #e2e8f0;
        padding: 10px;
      }

      .search-result-item:hover {
        background-color: #f3f4f6;
      }

      .search-result-title {
        color: #1e3a8a;
        font-weight: 600;
        font-size: 16px;
      }

      .search-result-description {
        color: #4b5563;
        font-size: 14px;
      }

      /* HTMX加载指示器 */
      .htmx-indicator {
        opacity: 0;
        transition: opacity 200ms ease-in;
      }
      .htmx-request .htmx-indicator {
        opacity: 1;
      }
      .htmx-request.htmx-indicator {
        opacity: 1;
      }
    </style>
    {% block extra_css %}{% endblock %}
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- 添加全局可用的CSRF令牌 -->
    {% csrf_token %}
    <header class="bg-blue-600 text-white shadow-md">
      <div
        class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center"
      >
        <div class="flex items-center mb-4 md:mb-0">
          <i class="fas fa-hospital text-2xl mr-2"></i>
          <h1 class="text-2xl font-bold cursor-pointer">
            <a href="{% url 'index' %}">医院内部导航站</a>
          </h1>
        </div>

        <div class="w-full md:w-1/3 relative">
          <div class="relative">
            <input
              type="text"
              id="search-input"
              class="w-full px-4 py-2 rounded-full text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-300"
              placeholder="搜索链接..."
              autofocus
              hx-get="/api/htmx/search"
              hx-trigger="keyup changed delay:300ms"
              hx-target="#search-results"
              hx-indicator="#search-indicator"
            />
            <button
              id="search-btn"
              class="absolute right-0 top-0 mt-2 mr-3 text-gray-600"
            >
              <i class="fas fa-search"></i>
            </button>
            <!-- 搜索加载指示器 -->
            <div
              id="search-indicator"
              class="htmx-indicator absolute right-12 top-2"
            >
              <div
                class="animate-spin rounded-full h-5 w-5 border-t-2 border-blue-500"
              ></div>
            </div>
          </div>
          <div
            id="search-results"
            class="absolute z-50 bg-white rounded-lg border border-gray-300 shadow-xl mt-1 w-full hidden search-results"
          >
            <!-- 搜索结果将在这里动态显示 -->
          </div>
        </div>

        <nav class="flex items-center space-x-6 mt-4 md:mt-0">
          <a href="{% url 'index' %}" class="hover:underline"
            ><i class="fas fa-home mr-1"></i> 首页</a
          >
          {% if user.is_authenticated %}
          <a href="{% url 'profile' %}" class="hover:underline"
            ><i class="fas fa-user mr-1"></i> 个人资料</a
          >
          <form method="post" action="{% url 'logout' %}" class="inline">
            {% csrf_token %}
            <button
              type="submit"
              class="hover:underline bg-transparent border-0 p-0 text-white"
            >
              <i class="fas fa-sign-out-alt mr-1"></i> 退出
            </button>
          </form>
          {% if user.is_staff %}
          <a href="{% url 'admin:index' %}" class="hover:underline"
            ><i class="fas fa-cog mr-1"></i> 管理后台</a
          >
          {% endif %} {% else %}
          <a href="{% url 'login' %}" class="hover:underline"
            ><i class="fas fa-sign-in-alt mr-1"></i> 登录</a
          >
          {% endif %}
          <a href="javascript:location.reload(true)" class="hover:underline">
            <i class="fas fa-sync-alt mr-1"></i> 刷新页面
          </a>
        </nav>
      </div>
    </header>

    <main class="flex-grow">{% block content %}{% endblock %}</main>

    <footer class="bg-gray-800 text-gray-300 py-6 mt-8">
      <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="mb-4 md:mb-0">
            <p class="text-center md:text-left">
              &copy; 2025 医院内部导航站 | 仅供内部使用
            </p>
          </div>
          <div class="flex items-center space-x-4">
            <a
              href="#"
              class="text-gray-400 hover:text-white transition-colors"
            >
              <i class="fas fa-question-circle"></i> 帮助
            </a>
            <a
              href="#"
              class="text-gray-400 hover:text-white transition-colors"
            >
              <i class="fas fa-info-circle"></i> 关于
            </a>
            <a
              href="#"
              class="text-gray-400 hover:text-white transition-colors"
            >
              <i class="fas fa-shield-alt"></i> 隐私政策
            </a>
          </div>
        </div>
      </div>
    </footer>

    {% block extra_js %}{% endblock %}

    <script>
      // 为所有HTMX请求添加CSRF令牌
      document.body.addEventListener("htmx:configRequest", function (evt) {
        if (evt.detail.verb === "post") {
          // 从cookie中获取CSRF令牌
          let csrfCookie = document.cookie
            .split(";")
            .find((c) => c.trim().startsWith("csrftoken="));
          if (csrfCookie) {
            let csrfToken = csrfCookie.split("=")[1];
            evt.detail.headers["X-CSRFToken"] = csrfToken;
          }
        }
      });

      // 监听HTMX响应，更新点击计数
      document.body.addEventListener("htmx:afterRequest", function (evt) {
        // 检查是否是点击计数请求
        if (evt.detail.requestConfig.path.includes("/click/")) {
          try {
            // 解析JSON响应
            const response = JSON.parse(evt.detail.xhr.response);
            if (response && response.click_count !== undefined && response.id) {
              // 获取链接ID
              const linkId = response.id;

              // 更新主页面中的计数
              const mainCountElement = document.getElementById(
                `click-count-${linkId}`
              );
              if (mainCountElement) {
                mainCountElement.textContent = response.click_count;
                addPulseAnimation(mainCountElement);
              }

              // 更新热门区域中的计数
              const popularCountElement = document.getElementById(
                `popular-count-${linkId}`
              );
              if (popularCountElement) {
                popularCountElement.textContent = response.click_count;
                addPulseAnimation(popularCountElement);
              }

              // 更新搜索结果中的计数
              document
                .querySelectorAll(
                  `.search-click-count[data-link-id="${linkId}"]`
                )
                .forEach((element) => {
                  element.textContent = response.click_count;
                  addPulseAnimation(element);
                });
            }
          } catch (e) {
            console.error("解析点击计数响应失败", e);
          }
        }
      });

      // 添加脉冲动画辅助函数
      function addPulseAnimation(element) {
        element.classList.add("pulse-animation");
        setTimeout(() => {
          element.classList.remove("pulse-animation");
        }, 300);
      }

      // 调试链接点击问题
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".link-content").forEach(function (link) {
          link.addEventListener("click", function (e) {
            console.log("链接被点击:", this.getAttribute("href"));
            // 确保链接正常工作
            if (!e.defaultPrevented) {
              const url = this.getAttribute("href");
              if (url) {
                window.open(url, "_blank");
              }
            }
          });
        });
      });

      // 处理点击计数JSON响应
      document.body.addEventListener("htmx:beforeSwap", function (evt) {
        // 检查是否是点击计数请求
        if (evt.detail.requestConfig.path.includes("/click/")) {
          try {
            // 尝试解析JSON
            const response = JSON.parse(evt.detail.xhr.response);
            if (response && response.click_count !== undefined) {
              // 替换响应内容为纯数字
              evt.detail.serverResponse = response.click_count;

              // 添加脉冲动画
              setTimeout(() => {
                const targetId = evt.detail.elt.id;
                const element = document.getElementById(targetId);
                if (element) {
                  element.classList.add("pulse-animation");
                  setTimeout(() => {
                    element.classList.remove("pulse-animation");
                  }, 300);
                }
              }, 50);
            }
          } catch (e) {
            // 如果解析失败，使用原始响应
            console.error("解析点击计数响应失败", e);
          }
        }
      });

      // 完全重写的搜索功能代码
      document.addEventListener("DOMContentLoaded", function () {
        // 防止重复初始化
        if (window._searchInitialized) return;
        window._searchInitialized = true;

        const searchInput = document.getElementById("search-input");
        const searchResults = document.getElementById("search-results");
        const searchClear = document.getElementById("search-clear");

        if (!searchInput || !searchResults) return;

        let searchTimeout;

        // 隐藏搜索结果的函数
        function hideSearchResults() {
          searchResults.classList.add("hidden");
          searchResults.style.display = "none";
        }

        // 显示搜索结果的函数
        function showSearchResults(html) {
          // 确保结果有内容才显示
          if (!html || html.trim() === "") {
            hideSearchResults();
            return;
          }

          searchResults.innerHTML = html;
          searchResults.classList.remove("hidden");

          // 强制样式设置确保可见
          Object.assign(searchResults.style, {
            display: "block",
            position: "absolute",
            width: "100%",
            zIndex: "9999",
            backgroundColor: "white",
            borderRadius: "0.5rem",
            boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
            maxHeight: "450px",
            overflowY: "auto",
          });
        }

        // 加上清空的直接事件监听
        searchInput.addEventListener("keyup", function (e) {
          // 如果输入为空，立刻隐藏结果
          if (this.value.trim() === "") {
            hideSearchResults();
            if (searchClear) searchClear.classList.add("hidden");
          }
        });

        // 监听输入事件，带防抖
        searchInput.addEventListener("input", function () {
          const query = this.value.trim();
          clearTimeout(searchTimeout);

          // 处理清除按钮显示
          if (searchClear) {
            if (query.length > 0) {
              searchClear.classList.remove("hidden");
            } else {
              searchClear.classList.add("hidden");
              hideSearchResults();
              return;
            }
          }

          // 改为只要有输入就显示结果
          if (query.length < 1) {
            // 从 < 2 改为 < 1
            hideSearchResults();
            return;
          }

          // 显示加载状态
          showSearchResults(
            '<div class="flex justify-center p-4"><div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-blue-500"></div></div>'
          );

          // 防抖处理
          searchTimeout = setTimeout(() => {
            const currentQuery = searchInput.value.trim();
            // 再次检查确保输入没有改变
            if (currentQuery !== query || currentQuery.length < 1) {
              // 这里也要改为 < 1
              if (currentQuery.length < 1) hideSearchResults();
              return;
            }

            // 发送搜索请求
            fetch(`/api/htmx/search?q=${encodeURIComponent(query)}`)
              .then((response) => response.text())
              .then((html) => {
                const latestQuery = searchInput.value.trim();
                if (latestQuery === query && latestQuery.length >= 1) {
                  showSearchResults(html);
                } else if (latestQuery.length < 1) {
                  hideSearchResults();
                }
              })
              .catch((err) => {
                console.error("搜索失败:", err);
                showSearchResults(
                  '<div class="p-4 text-gray-500 text-center">搜索出错，请重试</div>'
                );
              });
          }, 300);
        });

        // 点击外部区域隐藏搜索结果
        document.addEventListener("click", function (e) {
          if (
            !searchInput.contains(e.target) &&
            !searchResults.contains(e.target)
          ) {
            hideSearchResults();
          }
        });

        // 处理清除按钮
        if (searchClear) {
          searchClear.addEventListener("click", function (e) {
            e.stopPropagation();
            searchInput.value = "";
            hideSearchResults();
            this.classList.add("hidden");
            searchInput.focus();
          });
        }

        // ESC键处理
        searchInput.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            hideSearchResults();
          }
        });

        // 直接检查初始状态
        if (searchInput.value.trim() === "") {
          hideSearchResults();
          if (searchClear) searchClear.classList.add("hidden");
        }

        // 移除任何HTMX属性，确保不干扰我们的实现
        ["hx-get", "hx-post", "hx-trigger", "hx-target", "hx-swap"].forEach(
          (attr) => {
            if (searchInput.hasAttribute(attr))
              searchInput.removeAttribute(attr);
          }
        );

        // 搜索框自动聚焦
        if (searchInput) {
          setTimeout(() => searchInput.focus(), 100);
        }
      });

      // 添加直接点击处理作为备份
      document.addEventListener("DOMContentLoaded", function () {
        // 监听搜索结果的显示
        const searchInput = document.getElementById("search-input");
        const searchResults = document.getElementById("search-results");

        if (searchInput && searchResults) {
          // 当搜索结果显示时，为所有链接添加点击处理
          const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (
                mutation.type === "attributes" &&
                mutation.attributeName === "class" &&
                !searchResults.classList.contains("hidden")
              ) {
                // 为所有搜索结果链接添加直接点击处理
                document
                  .querySelectorAll(".search-result-item")
                  .forEach(function (item) {
                    // 确保只添加一次事件处理
                    if (!item.dataset.handlerAdded) {
                      item.dataset.handlerAdded = "true";

                      item.addEventListener("mousedown", function (e) {
                        const linkId = this.getAttribute("data-link-id");
                        if (!linkId) return;

                        console.log("搜索结果链接点击:", linkId);

                        // 使用原生fetch发送请求，避开HTMX
                        fetch(`/api/link/${linkId}/click/`, {
                          method: "POST",
                          headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": document.querySelector(
                              'input[name="csrfmiddlewaretoken"]'
                            ).value,
                          },
                          credentials: "same-origin",
                        })
                          .then((response) => {
                            if (!response.ok) throw new Error("请求失败");
                            return response.json();
                          })
                          .then((data) => {
                            console.log("点击计数更新成功:", data);
                            // 更新所有相关计数显示
                            document
                              .querySelectorAll(
                                `.search-click-count[data-link-id="${linkId}"]`
                              )
                              .forEach((el) => {
                                el.textContent = data.click_count;
                                addPulseAnimation(el);
                              });
                            // 同时更新主视图中的计数显示
                            const mainCount = document.getElementById(
                              `click-count-${linkId}`
                            );
                            if (mainCount) {
                              mainCount.textContent = data.click_count;
                              addPulseAnimation(mainCount);
                            }
                          })
                          .catch((err) =>
                            console.error("点击计数更新失败:", err)
                          );
                      });
                    }
                  });
              }
            });
          });

          // 监听搜索结果区域的变化
          observer.observe(searchResults, { attributes: true });
        }
      });
    </script>
  </body>
</html>
