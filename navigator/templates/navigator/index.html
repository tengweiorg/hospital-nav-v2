{% extends 'navigator/base.html' %} {% load static %} {% block extra_css %}
<link rel="stylesheet" href="{% static 'css/navigator.css' %}" />
{% endblock %} {% block content %}
<div class="container mx-auto px-4 py-3">
  <!-- IP信息条 -->
  <div
    class="bg-gradient-to-r from-blue-100 to-indigo-100 rounded-lg shadow-sm p-3 mb-4 flex flex-wrap justify-between items-center"
  >
    <div
      class="flex flex-col md:flex-row md:items-center space-y-2 md:space-y-0 md:space-x-3"
    >
      <div
        class="flex items-center bg-white py-1 px-3 rounded-full text-sm shadow-sm"
      >
        <i class="fas fa-network-wired text-blue-600 mr-2"></i>
        <span class="text-sm font-bold text-blue-500">您的电脑IP:</span>
        <span
          class="ml-1 text-blue-700 font-semibold tracking-wide bg-blue-50 px-1 py-0.5 rounded"
          >{{ client_ip }}</span
        >
      </div>

      <!-- 添加日期时间显示 -->
      <div
        class="flex items-center bg-white py-1 px-3 rounded-full text-sm shadow-sm"
      >
        <i class="fas fa-calendar-alt text-blue-600 mr-2"></i>
        <span id="current-date-display" class="text-gray-700"></span>
      </div>

      <div
        class="flex items-center bg-white py-1 px-3 rounded-full text-sm shadow-sm"
      >
        <i class="fas fa-clock text-blue-600 mr-2"></i>
        <span id="current-time-display" class="text-gray-700 font-mono"></span>
      </div>
    </div>
  </div>

  <!-- 将搜索容器添加相对定位确保结果正确展示
  <div
    class="relative flex-grow max-w-xl mx-auto z-50 mb-4"
    style="position: relative"
  >
    <div class="relative">
      <input
        id="search-input"
        type="text"
        placeholder="搜索链接..."
        class="w-full px-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent pl-10"
      />
      <div
        class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
      >
        <i class="fas fa-search"></i>
      </div>
      <div
        id="search-clear"
        class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 cursor-pointer hidden"
      >
        <i class="fas fa-times-circle"></i>
      </div>
    </div>

    <div
      id="search-results"
      class="search-results hidden"
      style="position: absolute; width: 100%; z-index: 9999"
    ></div>
  </div> -->

  <!-- 热门链接部分 -->
  <div class="mt-6">
    <div class="bg-white rounded-lg shadow-md p-4">
      <div class="flex items-center mb-4">
        <div
          class="p-2 rounded-lg bg-gradient-to-r from-blue-600 to-blue-800 text-white mr-3"
        >
          <i class="fas fa-fire"></i>
        </div>

        <h2 class="text-xl font-bold text-gray-800">热门链接</h2>
      </div>

        <div
          id="popular-links"
          hx-get="/api/htmx/popular"
          hx-trigger="load"
          hx-indicator="#popular-links-loader"
        >
          <div
            id="popular-links-loader"
            class="htmx-indicator flex justify-center py-4"
          >
            <div
              class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"
            ></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 分类区域 -->
    <div
      id="categories-container"
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
      hx-get="/api/htmx/categories"
      hx-trigger="load"
      hx-indicator="#categories-loader"
    >
      <div
        id="categories-loader"
        class="col-span-full text-center py-8 htmx-indicator"
      >
        <div class="inline-block">
          <div
            class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"
          ></div>
        </div>
        <p class="mt-2 text-gray-600">加载中...</p>
      </div>
    </div>
  </div>

  {% endblock %} {% block extra_js %}
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <script>
    // 更新时间函数
    function updateTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, "0");
      const minutes = String(now.getMinutes()).padStart(2, "0");
      const seconds = String(now.getSeconds()).padStart(2, "0");

      // 更新时间
      if (document.getElementById("current-time-display")) {
        document.getElementById("current-time-display").textContent =
          hours + ":" + minutes + ":" + seconds;
      }

      // 更新日期
      if (document.getElementById("current-date-display")) {
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        const weekdays = [
          "星期日",
          "星期一",
          "星期二",
          "星期三",
          "星期四",
          "星期五",
          "星期六",
        ];
        const weekday = weekdays[now.getDay()];

        document.getElementById("current-date-display").textContent =
          year + "年" + month + "月" + day + "日 " + weekday;
      }
    }

    // 初始化时间更新
    updateTime();
    setInterval(updateTime, 1000);

    // 监听HTMX事件
    document.addEventListener("htmx:afterRequest", function (evt) {
      if (
        evt.detail.elt.id === "popular-links" &&
        evt.detail.xhr.status === 200
      ) {
        const response = JSON.parse(evt.detail.xhr.responseText);
        let html = "";

        if (response.length > 0) {
          html =
            '<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">';
          response.forEach((link) => {
            html += `
            <a href="${
              link.url
            }" target="_blank" class="flex items-center p-2 rounded-lg bg-white shadow-sm hover:shadow-md transition-shadow">
              <div class="flex-shrink-0 bg-gradient-to-r from-amber-400 to-orange-500 text-white p-2 rounded mr-3">
                <i class="${link.icon_class || "fas fa-link"}"></i>
              </div>
              <div class="overflow-hidden">
                <div class="font-medium text-gray-800 truncate">${
                  link.title
                }</div>
                <div class="text-xs text-gray-500 flex items-center">
                  <i class="fas fa-eye mr-1"></i> ${link.click_count}
                </div>
              </div>
            </a>
          `;
          });
          html += "</div>";
        } else {
          html =
            '<div class="text-center py-3 text-gray-500">暂无热门链接</div>';
        }

        evt.detail.elt.innerHTML = `
        <div class="flex items-center space-x-3 mb-3">
          <div class="bg-gradient-to-r from-amber-400 to-orange-500 text-white p-2 rounded-lg">
            <i class="fas fa-fire"></i>
          </div>
          <h2 class="text-lg font-bold text-gray-800">热门链接</h2>
        </div>
        ${html}
      `;
      }
    });

    // 处理搜索
    document.addEventListener("DOMContentLoaded", function () {
      const searchInput = document.getElementById("search-input");
      const searchResults = document.getElementById("search-results");

      if (searchInput && searchResults) {
        searchInput.addEventListener("keyup", function () {
          const query = this.value.trim();
          if (query.length < 2) {
            searchResults.classList.add("hidden");
            return;
          }

          searchResults.classList.remove("hidden");
          htmx.ajax(
            "GET",
            `/api/htmx/search?q=${encodeURIComponent(query)}`,
            searchResults
          );
        });
      }
    });
  </script>
  {% endblock %}
</div>
